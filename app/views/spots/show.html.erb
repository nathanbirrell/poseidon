<!-- TODO: Figure out a nice way to handle notices -->
<% if notice && !notice.empty? %>
  <p id="notice"><%= notice %></p>
<% end %>

<% if (!@spot.current_swell || !@spot.current_wind) %>
  <h2><%= @spot.name %></h2>
  <p>No forecast data available for this spot.</p>
  <p>Please run a <code>rails forecasts:update</code> then refresh.</p>
<% else %>
  <% content_for :before_main do %>
    <div class="spot-banner">
      <div class="spot-banner__image-wrapper">
        <img alt="slide image" src="<%= @spot.image %>">
      </div>
      <div class="row spot-banner__content">
        <div class="small-12 columns text-center">
          <h2>
            <%= @spot.name %>, <br>
            <small><%= link_to @region.name, @region %>, <%= @region.state %></small>
          </h2>
          <p class="spot-banner__updated-date">Updated <%= time_ago_in_words(@spot.current_swell.updated_at.localtime) %> ago</p>
        </div>
      </div>
    </div>
  <% end %>

  <div id="overall-potential" class="row">
    <% if @spot.current_potential <= 30.0 %>
      <%= render partial: 'partials/floating-icon',  locals: {type: 'negative', icon: 'alert-triangle--white'} %>
    <% else %>
      <%= render partial: 'partials/rating-radial', locals: {rating: @spot.current_potential} %>
    <% end %>
    <span class="floating-icon --negative <%= 'hide' if @spot.current_potential >= 30.0%>"></span>
  </div>

  <% if user_signed_in? %>
    <div class="text-center">
      Admin actions: <br>
      <%= link_to 'Edit Spot', edit_spot_path(@spot), class: 'button' %> <br>
    </div>
  <% end %>

  <div class="row">
    <div class="large-12 columns">
      <div class="row">
        <div class="small-12 medium-4 columns">
          <div class="info-card">
            <div class="info-card__top">
              <h3 class="text-left">Swell</h3>
              <span class="text-right"><%= @spot.current_swell.date_time.localtime.strftime("%H:%M") %></span>
            </div>

            <div class="info-card__body row">
              <div class="small-4 columns">
                <% if @spot.current_swell.rating <= 30.0 %>
                  <%= render partial: 'partials/floating-icon',  locals: {type: 'negative', icon: 'alert-triangle--white'} %>
                <% else %>
                  <%= render partial: 'partials/rating-radial', locals: {rating: @spot.current_swell.rating, radius: '40'} %>
                <% end %>
              </div>

              <div class="small-4 columns">
                <p>
                  <strong><%= m_to_ft(@spot.current_swell.size).round(0) %></strong> <br>
                  <strong>@ <%= trim(@spot.current_swell.period.round(0))  %>s</strong>
                </p>
              </div>
              <div class="small-4 columns">
                <%= render partial: 'partials/floating-icon',  locals: {icon: 'navigation-2'} %>
                <strong><%= degrees_to_text(@spot.current_swell.direction) %></strong>
              </div>
            </div>
          </div>
        </div>
        <div class="small-12 medium-4 columns panel">
          <h4>Wind</h4>

          <% if @spot.current_wind.rating <= 30.0 %>
            <%= render partial: 'partials/floating-icon',  locals: {type: 'negative', icon: 'alert-triangle--white'} %>
          <% else %>
            <%= render partial: 'partials/rating-radial', locals: {rating: @spot.current_wind.rating} %>
          <% end %>

          <p>
            <ul>
              <li><strong>Speed:</strong> <%= kph_to_knots(@spot.current_wind.speed) %></li>
              <li><strong>Direction:</strong> <%= degrees_to_text(@spot.current_wind.direction) %><br></li>
              <li> at <%= @spot.current_wind.date_time.localtime.strftime("%a, %e %b %Y %H:%M") %></li>
            </ul>
          </p>
        </div>
        <div class="small-12 medium-4 columns panel">
          <h4>Tide</h4>

          <% if @spot.current_tide_rating <= 30.0 %>
            <%= render partial: 'partials/floating-icon',  locals: {type: 'negative', icon: 'alert-triangle--white'} %>
          <% else %>
            <%= render partial: 'partials/rating-radial', locals: {rating: @spot.current_tide_rating} %>
          <% end %>
          <p>
            <ul>
              <li><strong>Height:</strong> <%= @spot.current_tide_height %>m above sea level</li>
              <li><strong>Phase:</strong> <%= tide_incoming_or_outgoing(@spot.last_tide.tide_type) %></li>
              <li><strong>Next tide (<%= @spot.next_tide.tide_type %>):</strong> <%= @spot.next_tide.height %>m above sea level in <%= @spot.display_hours(@spot.time_till_next_tide_hours) %> hours <%= @spot.display_mins(@spot.time_till_next_tide_hours) %> mins (at
              <%= @spot.next_tide.date_time.localtime.strftime("%H:%M") %>)</li>
              <% if (@spot.tide_remaining_or_to != nil) %>
                <li>
                  <% if (@spot.tide_remaining_or_to == 'remaining') %>
                    <strong>Good tide remaining:</strong>
                  <% elsif (@spot.tide_remaining_or_to == 'to') %>
                    <strong>Time till good:</strong>
                  <% end %>
                  <%= @spot.display_hours(@spot.tide_hours_remaining) %> hours <%= @spot.display_mins(@spot.tide_hours_remaining) %> mins
                </li>
              <% end %>
            </ul>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="row small-collapse medium-uncollapse">
    <div class="large-12 columns">
      <div class="small-12 columns">
        <h4>About</h4>
      </div>
      <div class="large-6 small-12 columns">
        <h5 class="subheader"><%= @spot.description %></h5>
        <p>
          <strong>Optimal wind direction:</strong>
          <%= @spot.wind_optimal_direction %> degrees with <%= @spot.wind_optimal_direction_max_variance %> variance
          <br>
          <strong>Optimal wind strength:</strong>
          <%= @spot.wind_optimal_strength_min_kmh %> - <%= @spot.wind_optimal_strength_max_kmh %> kmh
          <br>
          <strong>Optimal swell direction:</strong>
          <%= @spot.swell_optimal_direction %> degrees with <%= @spot.swell_optimal_direction_max_variance %> variance
          <br>
          <strong>Optimal swell size:</strong>
          <%= @spot.swell_optimal_size_min_metres %> - <%= @spot.swell_optimal_size_max_metres %> metres
          <br>
          <strong>Optimal swell period:</strong>
          <%= @spot.swell_optimal_period_seconds %> secs
          <br>
          <strong>Optimal tides:</strong>
          <%= "#{@spot.tide_optimal_min_metres}m to #{@spot.tide_optimal_max_metres}m" %>
          <br>
          <strong>Season:</strong> <%= @spot.season %> <br>
          <strong>Lat/long: </strong> <%= @spot.latitude %>, <%= @spot.longitude %>
        </p>
      </div>
      <div class="large-6 small-12 columns">
        <%= render partial: 'partials/optimum-visualisation',
          locals: {
            showScale: true,
            label: 'Wind direction variance',
            min: 0,
            max: @spot.wind_optimal_direction_max_variance,
            value: @spot.current_wind.current_variance.abs,
            unit: " deg",
            roc: @spot.current_wind.rate_of_change_direction,
            rocDirection: 'right'
          }
        %>
        <%= render partial: 'partials/optimum-visualisation',
          locals: {
            label: 'Wind strength',
            min: @spot.wind_optimal_strength_min_kmh,
            max: @spot.wind_optimal_strength_max_kmh,
            value: @spot.current_wind.speed,
            unit: "km/h",
            roc: 20,
            rocDirection: 'left'
          }
        %>
        <%= render partial: 'partials/optimum-visualisation',
          locals: {
            label: 'Swell direction variance',
            min: 0,
            max: @spot.swell_optimal_direction_max_variance,
            value: @spot.current_swell.current_variance.abs,
            unit: " deg",
            roc: 7,
            rocDirection: 'right'
          }
        %>
        <%= render partial: 'partials/optimum-visualisation',
          locals: {
            label: 'Swell Size',
            min: @spot.swell_optimal_size_min_metres,
            max: @spot.swell_optimal_size_max_metres,
            value: @spot.current_swell.size.round(2),
            unit: "m",
            roc: 25,
            rocDirection: 'left'
          }
        %>
        <%= render partial: 'partials/optimum-visualisation',
          locals: {
            label: 'Tide height',
            min: @spot.tide_optimal_min_metres,
            max: @spot.tide_optimal_max_metres,
            value: @spot.current_tide_height,
            unit: "m",
            roc: 15,
            rocDirection: 'right'
          }
        %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="large-12 columns">
      <iframe
      width="100%"
      height="250"
      frameborder="0" style="border:0"
      src="https://www.google.com/maps/embed/v1/place?key=AIzaSyDVFmco07GE43aqioYPI5Ccfl_DJlGkBJo
        &q=loc:<%= @spot.latitude %>+<%= @spot.longitude %>&zoom=15" allowfullscreen>
      </iframe>
    </div>
  </div>


  <div class="row">
    <div class="small-12 medium-4 columns">
      <h3><%= "Swell Models for #{@spot.name}" %></h3>
      <%= swell_models_table(@forecasts_swells) %>
    </div>
    <div class="small-12 medium-4 columns">
      <h3><%= "Wind Models for #{@spot.name}" %></h3>
      <%= wind_models_table(@forecasts_winds) %>
    </div>
    <div class="small-12 medium-4 columns">
      <h3><%= "Tide Models for #{@spot.name}" %></h3>
      <%= tide_models_table(@forecasts_tides) %>
    </div>
  </div>

<% end %>
